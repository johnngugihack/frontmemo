<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Memo Viewer</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
       background: #1e1e2f;
      color: #f0f0f0;
      margin: 0;
      padding: 0;
    }
.logout-message {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 44px;
  color: yellow;
  background-color: rgba(0, 0, 0, 0.8); /* semi-transparent dark background */
  padding: 20px 40px;
  border-radius: 16px;
  opacity: 0;
  transition: opacity 1.5s ease;
  z-index: 9999;
  pointer-events: none;
}

.logout-message.show {
  opacity: 1;
}

body.fade-out {
  background-color: #000; /* ensure background is dark */
  opacity: 0;
  transition: opacity 1.5s ease, background-color 0.5s ease;
}

h1, h2 {
  color: black;
  text-align: center;
  font-size: 42px;
  padding: 15px 40px;
  font-weight: bold;
  background: linear-gradient(45deg, #00ffd5, #00b3ff);
  border: none;
  border-radius: 8px;
  width: 90%;
  transition: all 0.3s ease-in-out;

  margin: 20px auto; /* ‚úÖ centers the bar horizontally */
  box-shadow: 10px 10px 20px #b0b0b0, 1px 1px 20px #0a0f2c;


}


    form {
       background: #1e1e2f;
      padding: 30px;
      border-radius: 12px;
      max-width: 900px;
      margin: 30px auto;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
    }

    input, select {
      width: 100%;
      margin-bottom: 20px;
      padding: 26px;
      font-size: 25px;
      border-radius: 10px;
      border: 1px solid #444;
      background: #f9f9f9;
      color: white;
      height:50%;
      
    }

    button {
      padding: 15px 40px;
      font-size: 38px;
      font-weight: bold;
      background: linear-gradient(45deg, #00ffd5, #00b3ff);
      color: black;
      border: none;
      border-radius: 28px;
      cursor: pointer;
      transition: background 0.3s;

    }

    button:hover {
      background: linear-gradient(45deg, #00b3ff, #00ffd5);
    }

    #response {
      margin-top: 20px;
      font-size: 18px;
      font-weight: bold;
      text-align: center;
    }

 #filters {
  margin: 30px 0;
  display: flex;
  overflow-x: auto;
  gap: 10px;
  padding: 10px 20px;
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;
}

    .filter-button {
      margin: 6px;
      padding: 10px 25px;
      border-radius: 20px;
      background-color: #383b5c;
      color: #fff;
      font-weight: 600;
      font-size: 14px;
      border: 1px solid #555;
      cursor: pointer;
      transition: background-color 0.3s ease;
border: 5px solid;
   border-image: linear-gradient(45deg, black, white) 1; 
    }

    .filter-button:hover {
      background-color: #4e5170;
    }

    .memo {
      background: #292c3e;
      margin: 85px auto;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
      max-width: 75%;
      transition: transform 0.2s;
      box-shadow: 8px 8px 20px #0a0f2c, -8px -8px 20px #1a2349;



    }

    .memo:hover {
      transform: scale(1.02);
    }

    .memo img {
      max-width: 100%;
      height: auto;
      border: 2px solid #555;
      border-radius: 6px;
      margin-top: 12px;
    }

    .memo p {
      font-size: 15px;
      line-height: 1.6;
    }

    .dept-section {
      margin-bottom: 50px;
    }

.footer {
  width: 90%;
  background: #1e1e2f;
  padding: 40px 20px;
  text-align: center;
  margin: 20px auto;
  border-radius: 15px;
  color: white;

  border: 3px solid;
   border-image: linear-gradient(45deg, black, black) 1; /* üñåÔ∏è Gradient paint-like border */
 box-shadow: 10px 10px 20px #000000, -2px -2px 20px #1a1a1a;

}

.footer h4 {
  font-size: 34px;
  font-weight: bold;
  margin-bottom: 20px;
}

.footer p {
  font-size: 36px;
  color: white;
  margin: 10px 0;
}

.footer .icons {
  margin-top: 25px;
}

.footer .icons .fa {
  color: white;
  background: #00000055;
  border-radius: 50%;
  padding: 12px;
  margin: 0 10px;
  font-size: 20px;
  transition: background 0.3s ease, transform 0.2s ease;
}

.footer .icons .fa:hover {
  background: #000;
  transform: scale(1.1);
}

.footer .fa-heart-o {
  color: red;
  animation: beat 1.2s infinite;
}

@keyframes beat {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.2); }
}


    ::-webkit-scrollbar {
      width: 10px;
    }

    ::-webkit-scrollbar-track {
      background: #1e1e2f;
    }

    ::-webkit-scrollbar-thumb {
      background: #555;
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #777;
    }
    .badge {
  position: absolute;
  top: -15px;
  left: 50%;
  transform: translateX(10%);
  background: red;
  color: white;
  font-weight: bold;
  border-radius: 50%;
  padding: 4px 8px;
  font-size: 14px;
  min-width: 24px;
  text-align: center;
  box-shadow: 0 2px 5px rgba(0,0,0,0.4);
  z-index: 10;
}
.personin{

  background: #1e1e2f;
  border: 1px solid rgba(255,255,255,0.1);
  backdrop-filter: blur(4px);
  padding: 25px 21px;
  border-radius: 12px;
  color: white;
  width: 96%;
  font-size: 36px;
   appearance: none;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  transition: all 0.3s ease-in-out;
  box-shadow: 8px 8px 20px #000000, -8px -8px 20px #1a1a1a;


}
.personin:focus {
  outline: none;
  box-shadow: 0 0 8px #00ffd5;
  background-color: rgba(255, 255, 255, 0.08);
}
.personin::placeholder {
  color: white;
  opacity: 1; /* Ensures full visibility in some browsers */
  font-size: 40px;
}

.image{

 background: #1e1e2f;
  border: 1px solid rgba(255,255,255,0.1);
  backdrop-filter: blur(4px);
  padding: 23px 16px;
  border-radius: 12px;
  color: #eee;
  width: 96%;
  font-size: 36px; 
  background-position: right 1rem center;
  background-size: 29px;
  cursor: pointer;
  box-shadow: 8px 8px 20px #000000, -8px -8px 20px #1a1a1a;


  transition: all 0.3s ease-in-out;

}
.image:focus{

  outline: none;
  box-shadow: 0 0 8px #00ffd5;
  background-color: rgba(255, 255, 255, 0.08);s
}
.styled-select {
  background: #1e1e2f;
  border: 1px solid rgba(255,255,255,0.1);
  backdrop-filter: blur(4px);
  padding: 25px 16px;
  border-radius: 12px;
  color: #eee;
  width: 100%;
  font-size: 36px;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 140 140' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill='%23ffffff' d='M70 98l48-56H22z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 1rem center;
  background-size: 29px;
  cursor: pointer;
  box-shadow: 8px 8px 20px #000000, -8px -8px 20px #1a1a1a;

  transition: all 0.3s ease-in-out;
}

.styled-select:focus {
  outline: none;
  box-shadow: 0 0 8px #00ffd5;
  background-color: #1e1e2f;

}
.styled-select::depart{

  color: white;
  opacity: 1; /* Ensures full visibility in some browsers */
  
}







 .menu-icon {
      position: absolute;
      top: 20px;
      left: 20px;
      font-size: 70px;
      cursor: pointer;
      color: #fff;
      z-index: 1001;
    }


    /* Sidebar */
    .sidebar {
      position: fixed;
      top: 0;
      left: -350px;
      width: 350px;
      height: 100%;
      max-height: 100vh;        /* Limit height to viewport */
      overflow-y: auto; 
      background: #1e1e2f;
      color: #fff;
      padding-top: 60px;
     
       z-index: 2000;
       opacity: 0;
      transition: left 1s ease-in-out, opacity 1s ease-in-out;
      
    }

    .sidebar.open {
      
  left: 0;
  opacity: 1;
    }

    .sidebar button {
      display: block;
      width: 90%;
      margin: 30px auto;
      padding: 30px;
      
     
      cursor: pointer;
      text-align: left;
      font-size: 28px;
      background: linear-gradient(45deg, #00ffd5, #00b3ff);
      color: black;
      border: none;
      border-radius: 28px;
    }

    .sidebar button:hover {
      background: #ebf0c6;
    }


/* Styling the pop up window */

.popup-modal {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow-y: auto;
  background-color: rgba(0,0,0,0.6);
}

.popup-content {
  position: relative;   /* added */
  background-color: gray;
  margin: 60px auto;
  padding: 20px;
  border-radius: 10px;
  width: 90%;
  max-width: 1000px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

#modalCloseBtn {
  position: absolute;
  bottom: 20px;       /* 20px up from bottom of .popup-content */
  right: 200px;        /* 20px in from right edge */
  font-size: 2.7rem;
  background-color: red;
  color: black;
  border: none;
  border-radius: 4px;
  padding: 0.5rem 1rem;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  text-align:center;
  transition: background-color 0.2s ease-in-out;
  width: 55%;
}

#modalCloseBtn:hover {
  background-color: red;
}


 .scroll-wrapper {
  overflow-x: auto;
  padding: 10px;
}

.button-container {
  display: flex;
  gap: 30px;
  min-width: max-content;
}

.approval-box {
  border: 1px solid #ccc;
  padding: 12px;
  min-width: 180px;
  border-radius: 8px;
  box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
  background: #1e1e2f;
  text-align: center;
}

.box-title {
  font-weight: bold;
  margin-bottom: 8px;
}

button {
  display: block;
  width: 100%;
  margin: 5px 0;
  padding: 8px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  margin-top: 20px;
}

button:disabled {
  background-color: #ddd;
  color: red;
  cursor: not-allowed;
}

.reject-btn {
  background-color: #f44336;
  color: black;
}

.reject-btn:hover {
  background-color: #d32f2f;
}
.logout-link {
  text-decoration: none;
   background-color:red;
  

}



  </style>
</head>
<body>

  <i class="fa fa-bars menu-icon" id="menuToggle"></i>
 
<button onclick="logoutWithFade()" style="text-align: center;">
  <strong>LOGOUT</strong>
</button>

  <!-- Sidebar -->
<div class="sidebar" id="sidebarMenu">
  <a href="index.html" class="logout-link">
    <button style="text-align: center;">
      <strong >LOGOUT</strong>
    </button>
  </a>

  <button onclick="loadMemosforsidebar('Director')">Memos To Director</button>

  <button onclick="loadMemosforsidebar('Hr')">Memos To HR</button>

  <button onclick="loadMemosforsidebar('Commercial')">Memos To Commercial</button>
  <button onclick="loadMemosforsidebar('Accounts')">Memos To Accounts</button>
  <button onclick="loadMemosforsidebar('Ict')">Memos To ICT</button>
  <button onclick="loadMemosforsidebar('Engineering')">Memos To Engineering</button>
  <button onclick="loadMemosforsidebar('Registry')">Memos To Registry</button>
  
</div>


<!-- Modal Structure -->
<!-- Memo Modal -->
<div id="popupModal" class="popup-modal">
  <div class="popup-content">
    <span id="modalCloseBtn" onclick="closeModal()"><strong>Close</strong></span>
    <h2 id="popupTitle"></h2>
    <div id="popupBody"></div>
    <!-- Move your Close button here, at the bottom: -->
    
  </div>
</div>

<div id="commentModal" style="display: none; position: fixed; top: 30%; left: 50%; transform: translate(-50%, -30%);
 background: white; padding: 20px; border-radius: 10px; z-index: 20000; color: black; max-width: 90%; width: 700px;">
  <label for="commentInput">Enter your comment:</label><br>
  <textarea id="commentInput" rows="4" style="width: 100%; margin-top: 10px;"></textarea><br><br>
 <button onclick="submitComment(event)">Submit</button>

  <button onclick="closeModall()">Cancel</button>
</div>



  <form id="memoForm" enctype="multipart/form-data">
    <h2 style="width: 95%;  margin-left:-15px; border-radius: 10px;">Approval Workflow Center</h2>
    <input  type="text" name="person" placeholder="Submitted by..." class="personin" required />
    


<!-- Display selected departments as tags -->
<div id="tagContainer" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 6px;"></div>

<!-- The dropdown -->
<select id="destinationSelect" class="styled-select">
  <option value="" disabled selected>Select the path of the memo ...</option>
  <option value="Director">Director</option>
  <option value="Hr">Human Resources</option>
  <option value="Commercial">Commercial</option>
  <option value="Accounts">Accounts</option>
  <option value="ICT">ICT</option>
  <option value="Engineering">Engineering</option>
  <option value="Registry">Registry</option>
</select>

<!-- Hidden field that will carry the full path for backend -->
<input type="hidden" name="destination" id="approvalPathInput" required />

 
</select>


    <input type="file" id="fileInput" name="memo" accept="image/*" class="image" required />
    <button type="submit" id="uploadBtn" style="font-size:50px"><b>UPLOAD</b></button>
  </form>
<div id="uploadStatus" style="margin-top: 10px;"></div>

  <div id="response"></div>

  <h1 style="border-radius: 0px;">FILES BY DEPARTMENT</h1>
  <div id="filters"></div>
  <div id="memos-container"></div>

  <section class="footer">
    <h4>About Developer</h4>
    <p >Built with passion by a Computer Science enthusiast who believes in the power of code to solve real-world problems.</p>
    <p>&copy; 2025 | Keep learning. Keep building.</p>
    <div class="icons">
      <a href=""><i class="fa fa-facebook"></i></a>
      <a href=""><i class="fa fa-instagram"></i></a>
      <a href=""><i class="fa fa-twitter"></i></a>
      <a href=""><i class="fa fa-linkedin"></i></a>
    </div>
    <p>Made with&nbsp; <i class="fa fa-heart-o"></i> &nbsp;&nbsp; by John Ngugi</p>
  </section>

 <script>
function getRoleFromToken(token) {
  try {
    const payload = JSON.parse(atob(token.split('.')[1]));
    return payload.role; // adjust if role is nested
  } catch (e) {
    return null;
  }
}
//transition for logging out
function logoutWithFade() {
  const message = document.createElement('div');
  message.className = 'logout-message';
  message.textContent = 'Logging out... Bye üëã';

  document.body.appendChild(message);

  // Trigger fade
  setTimeout(() => {
    message.classList.add('show');
    document.body.classList.add('fade-out');
  }, 200); // slight delay to allow DOM paint

  // Redirect after fade-out
  setTimeout(() => {
    window.location.href = 'index.html';
  }, 1600); // must be longer than CSS transition duration
}

const token = sessionStorage.getItem('token');
const role = token ? getRoleFromToken(token) : null;

const fileInput = document.getElementById('fileInput');

fileInput.addEventListener('change', function () {
  if (this.files.length === 0) {
    const newInput = this.cloneNode(true);
    this.replaceWith(newInput);
  }
});

// ‚úÖ Redirect if no valid role found
if (!role) {
  window.location.href = 'index.html';
}

  const menuToggle = document.getElementById('menuToggle');
    const sidebar = document.getElementById('sidebarMenu');
   let idleTime = 0;
  const maxIdle = 30 * 60 * 1000; // 30 minutes

  let idleInterval;


   menuToggle.addEventListener('click', (event) => {
  sidebar.classList.add('open');
  event.stopPropagation();
});





const destinationSelect = document.getElementById('destinationSelect');
  const tagContainer = document.getElementById('tagContainer');
  const hiddenInput = document.getElementById('approvalPathInput');

  let selectedDepartments = [];

  destinationSelect.addEventListener('change', () => {
    const selected = destinationSelect.value;
    if (selected && !selectedDepartments.includes(selected)) {
      selectedDepartments.push(selected);
      updateTags();
      updateHiddenInput();
    }
    destinationSelect.selectedIndex = 0;
  });



// Clear the input field and the box above the destination input
function clearTags() {
  selectedDepartments = [];
  updateTags();
  updateHiddenInput();
  tagContainer.style.display = 'none'; 
}


function updateTags() {
  // Apply scrollable styles to the container
  tagContainer.style.maxHeight = '200px';
  tagContainer.style.overflowY = 'auto';
  tagContainer.style.display = 'flex';
  tagContainer.style.flexWrap = 'wrap';
  tagContainer.style.gap = '10px';
  tagContainer.style.padding = '10px';
  tagContainer.style.border = '5px solid #ccc';

  tagContainer.innerHTML = '';

  selectedDepartments.forEach(dep => {
    const tag = document.createElement('span');
    tag.textContent = dep + ' ‚úï';
    tag.style = `
      background: #007bff;
      color: white;
      padding: 5px 10px;
      border-radius: 12px;
      font-size: 40px;
      cursor: pointer;
      margin-bottom: 5px;
    `;
    tag.onclick = () => {
      selectedDepartments = selectedDepartments.filter(d => d !== dep);
      updateTags();
      updateHiddenInput();
    };
    tagContainer.appendChild(tag);
  });
}

  function updateHiddenInput() {
    hiddenInput.value = JSON.stringify(selectedDepartments); // store as JSON string
  }
document.addEventListener('click', (event) => {
  if (!sidebar.contains(event.target) && !menuToggle.contains(event.target)) {
    sidebar.classList.remove('open'); // Smoothly slides out due to CSS transition
  }
});


    // Optional: Prevent closing when clicking inside sidebar
    sidebar.addEventListener('click', (event) => {
      event.stopPropagation();
    });

// Above controls the side bar slide
  const form = document.getElementById('memoForm');
  const responseBox = document.getElementById('response');
  const button = document.getElementById("uploadBtn");
  const statusDiv = document.getElementById("uploadStatus");
  const hiddenPathInput = document.getElementById("approvalPathInput");
  

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const token = sessionStorage.getItem("token");

    if (!token) {
      responseBox.textContent = "‚ùå You are not logged in.";
      responseBox.style.color = 'red';
      return;
    }

    // Show uploading UI
    button.disabled = true;
    button.innerHTML = `<span class="spinner" style="margin-right: 8px;"></span> <span style="color: yellow;">Uploading...</span>`;
    statusDiv.innerHTML = `<span style="color: yellow; font-size: 35px;">Please wait while we upload your file...</span>`;

    try {
      const res = await fetch('https://memo-locator-production.up.railway.app/upload', {
        method: 'POST',
        headers: {
          "Authorization": `Bearer ${token}`
        },
        body: formData
      });

      const data = await res.json();

      if (res.ok) {
        // ‚úÖ Upload succeeded
        responseBox.textContent = `‚úÖ ${data.message}`;
        responseBox.style.color = 'green';

	clearTags();                      // üëà Clear DOM tags first
	hiddenPathInput.value = "";      // üëà Clear the hidden input
	selectedDepartments = [];        // üëà Optional, if you're using this variable
       
        form.reset();
       
        // Re-set the 'person' input field with username from token
        const decoded = parseJwt(token);
        if (decoded && decoded.sub) {
          const personInput = document.querySelector('input[name="person"]');
          if (personInput) {
            personInput.value = decoded.sub;
            personInput.style.color = "yellow";
            personInput.readOnly = true;
          }
        }

        // Reset button and status UI
        button.innerHTML = "UPLOAD";
        button.style.color = "black";
        button.style.fontWeight = "bold";
        button.disabled = false;
        statusDiv.textContent = "";

        // Fade out success message
        setTimeout(() => {
          responseBox.style.opacity = '0';
          setTimeout(() => responseBox.textContent = '', 500);
          responseBox.style.opacity = '1';
        }, 4000);

      } else {
        // ‚ùå Error from server
        handleUploadError(data.detail || data.error || 'Upload failed.');
      }

    } catch (err) {
      console.error(err);
      handleUploadError('‚ùå Failed to upload memo.');
    }
  });

  function handleUploadError(msg) {
    responseBox.textContent = msg;
    responseBox.style.color = 'red';
    button.disabled = false;
    button.innerHTML = "UPLOAD";
    button.style.color = "black";
    button.style.fontWeight = "bold";
    statusDiv.textContent = "";
    form.reset(); // Still reset the form on failure
  }

  function clearTags() {
    const tagContainer = document.getElementById("tagContainer");
    if (tagContainer) tagContainer.innerHTML = "";
  }

 
  function parseJwt(token) {
    try {
      return JSON.parse(atob(token.split('.')[1]));
    } catch (e) {
      return null;
    }
  }

  // Populate 'person' input on page load
  window.addEventListener("DOMContentLoaded", () => {
    const token = sessionStorage.getItem("token");
    if (token) {
      const decoded = parseJwt(token);
      if (decoded && decoded.sub) {
        const personInput = document.querySelector('input[name="person"]');
        if (personInput) {
          personInput.value = decoded.sub;
          personInput.style.color = "yellow";
          personInput.readOnly = true;
        }
      }
    }
  });

  let currentDepartment = null; // will track the current view
  let currentHash = '';

//reject the memo
async function rejectMemo(memoId, department) {
  const button = event.target;
  const originalText = button.textContent;
  const comment = prompt("Enter your comment for this memo approval:");

  // If user cancels or leaves it blank, you can decide whether to proceed or not
  if (comment === null) {
    // User clicked Cancel
    return;
  }

  button.textContent = 'Declining...';
  button.disabled = true;
  button.style.backgroundColor = 'orange';
  button.style.color = 'yellow';

   try {
    const res = await fetch('https://memo-locator-production.up.railway.app/reject', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({memoId, role, comment })
    });

    const data = await res.json();
    if (res.ok) {
      alert(`‚úÖ ${data.message}`);
      await loadMemos();
    } else {
      alert(`‚ùå ${data.error || 'Reject failed'}`);
    }
  } catch (error) {
    console.error('Reject request failed', error);
    alert('‚ùå Reject request failed. Check network or contact support.');
  }
finally {
    button.textContent = originalText;
    button.disabled = false;
    button.style.backgroundColor = ''; // reset to original
    button.style.color = '';
  }
}








function getRoleFromToken() {
  const token = sessionStorage.getItem('token');
  if (!token) return null;

  try {
    const payloadBase64 = token.split('.')[1];
    const payloadJson = atob(payloadBase64); // Decode base64
    const payload = JSON.parse(payloadJson);
    return payload.role?.toLowerCase() || null;
  } catch (e) {
    console.error("Failed to decode token:", e);
    return null;
  }
}
function getVoteFromToken() {
  const token = sessionStorage.getItem('token');
  if (!token) return null;

  try {
    const payloadBase64 = token.split('.')[1];
    const payloadJson = atob(payloadBase64); // Decode base64
    const payload = JSON.parse(payloadJson);
    return payload.vote ?? null; // could be 0 or 1
  } catch (e) {
    console.error("Failed to decode token:", e);
    return null;
  }
}


function generateApprovalButtons(memo) {
  const role = getRoleFromToken();
  const vote = getVoteFromToken();

  if (!role || vote !== 1) return ''; // ‚õîÔ∏è Don't show anything if not allowed to vote

  let destinations = [];
  try {
    destinations = JSON.parse(memo.destination || '[]').map(d => d.toLowerCase());
  } catch (e) {
    console.error("Invalid destination format", memo.destination);
  }

  let buttonsHTML = '';

  function createBox(dept) {
    const userIsInDept = role === dept;
    if (!userIsInDept) return ''; // ‚õîÔ∏è Only show button for the logged-in role

    return `
      <div class="approval-box">
        <div class="box-title" style="font-size: 1.2rem; font-weight: bold;">${capitalize(dept)} Approval</div>
        <button onclick="approveMemo(${memo.id}, '${dept}')" style="font-size: 20px; font-weight: bold;">
          ${capitalize(dept)} Approve
        </button>
        <button class="reject-btn" onclick="rejectMemo(${memo.id}, '${dept}')" style="font-size: 20px; font-weight: bold; padding: 10px 16px;">
          ${capitalize(dept)} Decline
        </button>
      </div>
    `;
  }

  destinations.forEach(dept => {
    buttonsHTML += createBox(dept);
  });

  return `<div class="scroll-wrapper"><div class="button-container">${buttonsHTML}</div></div>`;
}


function capitalize(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}

//showing comments
function renderComment(comments) {
  if (!comments || typeof comments !== 'object') return '';

  let visibleComments = Object.entries(comments)
    .filter(([_, comment]) => comment && comment.trim() !== '')
    .map(([dept, comment]) => {
      return `<p style="font-size: 28px;"><strong>${dept.toUpperCase()}:</strong> ${comment}</p>`;
    });

  if (visibleComments.length === 0) return '';

  return `
    <div class="comment-box" style="margin-top:10px; padding:10px; background:#f9f9f9; color:black; border-left:4px solid #007BFF; border-radius:5px;">
      <strong style="font-size: 25px;">Comments:</strong>
      ${visibleComments.join('')}
    </div>
  `;
}


async function loadMemos() {
  try {
    const res = await fetch('https://memo-locator-production.up.railway.app/view');
    const data = await res.json();
    if (!res.ok) throw new Error('Failed to fetch memos');
// Memo grouping meehn by department
    const allMemos = data.data;
    const grouped = {};
    allMemos.forEach(memo => {
      const dept = memo.department || 'Other';
      if (!grouped[dept]) grouped[dept] = [];
      grouped[dept].push(memo);
    });

    const container = document.getElementById('memos-container');
    const filterBar = document.getElementById('filters');
    container.innerHTML = '';
    filterBar.innerHTML = '';
//Department creation
    Object.entries(grouped).forEach(([dept, memos]) => {
      if (memos.length === 0) return;

      // Button wrapper
      const buttonWrapper = document.createElement('div');
      buttonWrapper.style.position = 'relative';
      buttonWrapper.style.display = 'inline-block';
      buttonWrapper.style.margin = '10px';
      buttonWrapper.style.textAlign = 'center';

      // Button
      const button = document.createElement('button');
      button.textContent = dept.toUpperCase();

      button.className = 'filter-button';
      button.setAttribute('data-department', dept);
      button.style.fontSize = '2rem';
      button.style.color = 'black';
      button.style.fontWeight = '600';
      if (dept === currentDepartment) {
        button.classList.add('active');
      }

      // Badge
      const badge = document.createElement('span');
      badge.textContent = memos.length;
      badge.className = 'badge';

      buttonWrapper.appendChild(badge);
      buttonWrapper.appendChild(button);
      filterBar.appendChild(buttonWrapper);

      button.onclick = () => {
        currentDepartment = dept;
        filterMemosByDepartment(dept);
      };

      // Memos section
      const deptDiv = document.createElement('div');
      deptDiv.className = 'dept-section';
      deptDiv.id = `dept-${dept}`;

      const title = document.createElement('h2');
      title.textContent = 'From ' + dept.toUpperCase() + ' Department';
      deptDiv.appendChild(title);

      memos.forEach(memo => {
        const div = document.createElement('div');
        div.className = 'memo';
        div.setAttribute('data-memo-id', memo.id);
         
        div.innerHTML = `
          <p style="font-size:31px;"><strong style="color: #ADD8E; font-size:25px;">From:</strong> ${memo.submitted_by}</p>
          <p style="font-size:31px;"><strong style="color: #ADD8E; font-size:25px;">From: ${memo.department} Department</strong> </p>

          <p style="font-size:31px;"><strong style="color: #ADD8E; font-size:25px;">To: </strong>[${formatDestination(memo.destination)}] Department </p>
          
          <img src="${memo.image_url}" alt="Memo Image" />
          <div class="approval-status" data-id="${memo.id}">
          ${generateApprovalStatusHTML(memo.approval_status, memo.destination, memo.status)}
          ${renderComment(memo.comments)}

          </div>

          <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
            ${generateApprovalButtons(memo)}
          </div>
          <hr style="border: none; height: 3px; background: linear-gradient(to right, #00f2ff, #00ffae, #00f2ff); margin: 10px 0 20px 0; border-radius: 10px;" />
          <p style="font-size:31px;"><strong style="color: #ADD8E; font-size:25px;">Submitted on:</strong> ${memo.created_at}</p>
        `;

        deptDiv.appendChild(div);
      });

      container.appendChild(deptDiv);
    });

    // Show selected department or default
    const firstDept = Object.keys(grouped)[0];
    if (!currentDepartment || !grouped[currentDepartment]) {
      currentDepartment = firstDept;
    }
    filterMemosByDepartment(currentDepartment);

  } catch (err) {
    document.body.innerHTML = '<p style="color:red;">There is an issue. Please contact John (0110426848).</p>';
    console.error(err);
  }
}

//showing pending  statuses




function getApprovalRoles(destination) {
  try {
    const parsed = JSON.parse(destination);
    if (Array.isArray(parsed)) {
      return Array.from(new Set(parsed.map(role => role.trim().toLowerCase())));
    }
  } catch (e) {
    // If not JSON, treat as single string role
    return [destination.trim().toLowerCase()];
  }
  return [];
}






function generateApprovalStatusHTML(statusList, destination, overallStatus = "") {
  const expectedRoles = getApprovalRoles(destination).map(r => r.toLowerCase());
  const matchedRoles = new Set();
  const statusHTML = [];

  // Include overallStatus if it's not already in statusList
  if (overallStatus && !statusList.includes(overallStatus)) {
    statusList = [...statusList, overallStatus];
  }

  statusList.forEach(status => {
    const lower = status.toLowerCase();
    let role = null;

    // Match for approval or rejection
    if (lower.includes("approved")) {
      const match = lower.match(/approved by ([\w\s]+)/) || lower.match(/^([\w\s]+?)\s+approved/);
      if (match) role = match[1].trim().toLowerCase();
      if (role && expectedRoles.includes(role)) {
        matchedRoles.add(role);
        statusHTML.push(createStatusLine("‚úÖ", "green", status));
      }
    } else if (lower.includes("rejected")) {
      const match = lower.match(/rejected by ([\w\s]+)/) || lower.match(/^([\w\s]+?)\s+rejected/);
      if (match) role = match[1].trim().toLowerCase();
      if (role && expectedRoles.includes(role)) {
        matchedRoles.add(role);
        statusHTML.push(createStatusLine("‚ùå", "red", status));
      }
    } else {
      // Handle pending
      const match = lower.match(/pending approval from ([\w\s]+)/);
      if (match) {
        role = match[1].trim().toLowerCase();
        if (expectedRoles.includes(role)) {
          matchedRoles.add(role);
          statusHTML.push(createStatusLine("‚òê", "orange", status));
        }
      }
    }
  });

  // Add "Pending" lines for roles that haven't acted
  expectedRoles.forEach(role => {
    if (!matchedRoles.has(role)) {
      statusHTML.push(createStatusLine("‚òê", "orange", `Pending approval from ${capitalize(role)}`));
    }
  });

  return statusHTML.join('');
}

// Helper functions
function createStatusLine(icon, color, text) {
  return `
    <div style="display: flex; align-items: center; gap: 8px; margin-top: 10px;">
      <span style="font-size: 30px; color: ${color};">${icon}</span>
      <span style="color: ${color}; font-size: 27px; font-family: sans-serif;">${text}</span>
    </div>
  `;
}

function capitalize(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}

function closeModall() {
  document.getElementById('commentModal').style.display = 'none';
  document.getElementById('commentInput').value = '';
}


let currentMemoId = null;
let currentRole = null;

function approveMemo(memoId, role) {
  currentMemoId = memoId;
  currentRole = role;
  document.getElementById('commentModal').style.display = 'block';
}

function closeModal() {
  document.getElementById('commentModal').style.display = 'none';
  document.getElementById('commentInput').value = '';
}

async function submitComment(event) {
  const comment = document.getElementById('commentInput').value.trim();
  const submitBtn = event.target;
  const originalText = submitBtn.textContent;

  if (!comment) {
    alert("Please enter a comment.");
    return;
  }

  submitBtn.textContent = 'Submitting...';
  submitBtn.disabled = true;

  try {
    const res = await fetch('https://memo-locator-production.up.railway.app/approve', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        memo_id: currentMemoId,
        role: currentRole,
        comment: comment
      })
    });
closeModall();
    const data = await res.json();
    if (res.ok) {
      alert(`‚úÖ ${data.message}`);
      await loadMemos();
      closeModall(); // ‚úÖ This closes the modal after success
    } else {
      alert(`‚ùå ${data.detail || data.error || 'Approval failed'}`);
    }
  } catch (error) {
    console.error('Approval request failed', error);
    alert('‚ùå Network or server error');
  } finally {
    submitBtn.textContent = originalText;
    submitBtn.disabled = false;
  }
}

function filterMemosByDepartment(dept) {
  // Show only the selected department section
  document.querySelectorAll('.dept-section').forEach(sec => {
    sec.style.display = sec.id === `dept-${dept}` ? 'block' : 'none';
  });

  // Highlight the active button and show feedback
  document.querySelectorAll('.filter-button').forEach(btn => {
    const isActive = btn.getAttribute('data-department') === dept;

    // Apply inline styles
    if (isActive) {
      btn.style.backgroundColor = '#28a745'; // green
      btn.style.color = 'black'; // white text
      btn.style.border = '1px solid #218838';
      btn.style.borderRadius = '5px';

      const originalText = btn.innerText;
      btn.innerText = '‚úì Selected';
      btn.disabled = true;

      setTimeout(() => {
        btn.innerText = originalText;
        btn.disabled = false;

        // Keep active color after restoring text
        btn.style.backgroundColor = 'yellow';
        btn.style.color = 'yellow';
      }, 1000);
    } else {
      // Reset styles for inactive buttons
      btn.style.backgroundColor = '#f0f0f0';
      btn.style.color = '#333333';
      btn.style.border = '1px solid #cccccc';
      btn.style.borderRadius = '5px';
    }
  });
}



  async function loadMemosIfChanged() {
    try {
      const res = await fetch('https://memo-locator-production.up.railway.app/view');
      const data = await res.json();
      const newHash = JSON.stringify(data.data.map(m => m.id + m.approval_status.join(',')));

      if (newHash !== currentHash) {
        currentHash = newHash;

        const scrollY = window.scrollY;
        await loadMemos();
        window.scrollTo(0, scrollY);
      }
    } catch (err) {
      console.error('Conditional memo refresh failed', err);
    }
  }


 function resetIdleTimer() {
  idleTime = 0;
}

function startIdleTimer() {
  idleInterval = setInterval(() => {
    idleTime += 1000;
    if (idleTime >= maxIdle) {
      clearInterval(idleInterval);  // stop the interval to prevent multiple alerts
      localStorage.removeItem('role');
      localStorage.removeItem('roleSetTime');
      alert('You have been logged out due to inactivity.');
      window.location.href = 'index.html'; 
    }
  }, 1000);
}

// ‚úÖ Attach activity listeners to reset the timer
window.onload = () => {
  startIdleTimer();

  window.addEventListener('mousemove', resetIdleTimer);
  window.addEventListener('keydown', resetIdleTimer);
  window.addEventListener('click', resetIdleTimer);
  window.addEventListener('scroll', resetIdleTimer);
};







async function loadMemosforsidebar(destination) {
  try {
    const res = await fetch('https://memo-locator-production.up.railway.app/view');
    const data = await res.json();
    if (!res.ok) throw new Error('Failed to fetch memos');

    const allMemos = data.data;
    const normalizedDest = destination.trim().toLowerCase();

    const filteredMemos = allMemos.filter(memo => {
      try {
        // Try to parse the destination as a JSON array
        const parsedDest = JSON.parse(memo.destination);
        if (Array.isArray(parsedDest)) {
          return parsedDest.some(d => d.trim().toLowerCase() === normalizedDest);
        }
      } catch {
        // Fallback for single string destination
        return (memo.destination || '').trim().toLowerCase() === normalizedDest;
      }
      return false;
    });

    if (filteredMemos.length > 0) {
      showMemosInModal(destination, filteredMemos);
    } else {
      alert(`No memos found for ${destination}`);
    }

  } catch (err) {
    document.body.innerHTML = '<p style="color:red;">There is an issue. Please contact John (0110426848).</p>';
    console.error(err);
  }
}
function formatDestination(destination) {
  try {
    const destArray = JSON.parse(destination);
    if (Array.isArray(destArray)) {
      return destArray.map(d => d.trim()).join(', ');
    }
  } catch {
    // Fallback if destination is not a JSON array
    return destination;
  }
  return destination;
}

async function showMemosInModal(destination, memos) {
  const modal = document.getElementById('popupModal');
  const title = document.getElementById('popupTitle');
  const body = document.getElementById('popupBody');

  // Clear previous content
  if (title) title.textContent = '';
  if (body) body.innerHTML = '';

  // Set modal title
  title.textContent = `Memos Received In ${destination} Department`;

  // Render each memo
  memos.forEach(memo => {
    const div = document.createElement('div');
    div.className = 'memo';

    div.innerHTML = `
      <p style="font-size:34px;"><strong>From:</strong> ${memo.submitted_by}</p>
      <p style="font-size:34px;"><strong>Department:</strong> ${memo.department} Department</p>
      <p style="font-size:34px;"><strong>To:</strong> [${formatDestination(memo.destination)}] Department</p>

      <img src="${memo.image_url}" alt="Memo Image" style="max-width:100%; border-radius:8px; margin:10px 0;" />
      <div class="approval-status" data-id="${memo.id}">
        ${generateApprovalStatusHTML(memo.approval_status, memo.destination, memo.status)}
        ${renderComment(memo.comments)}
      </div>
      
      <div style="margin-top: 10px;">
        ${generateApprovalButtons(memo)}
      </div>
      <hr />
      <p style="font-size:34px;"><strong>Submitted on:</strong> ${memo.created_at}</p>
    `;

    body.appendChild(div);
  });

  // Show modal
  modal.style.display = 'block';
  modal.style.zIndex = '9999';
}

function closeModal() {
  document.getElementById('popupModal').style.display = 'none';
}

function parseJwt(token) {
  try {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(
      atob(base64).split('').map(c =>
        '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
      ).join('')
    );
    return JSON.parse(jsonPayload);
  } catch (e) {
    console.error("Failed to parse JWT:", e);
    return null;
  }
}

window.addEventListener("DOMContentLoaded", () => {
  const token = sessionStorage.getItem("token"); // or however you store it

  if (token) {
    const decoded = parseJwt(token);
    if (decoded && decoded.sub) {
      const username = decoded.sub;

      const personInput = document.querySelector('input[name="person"]');
      if (personInput) {
        personInput.value = username;
        personInput.style.color = "yellow";
        personInput.readOnly = true;
      }
    }
  }
});



 
  setInterval(loadMemosIfChanged, 5000);
  loadMemos();
</script>


</body>
</html>
